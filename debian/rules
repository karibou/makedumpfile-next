#!/usr/bin/make -f

# Figure out the git branch we're on
branch = $(shell git symbolic-ref HEAD 2>/dev/null | sed s:refs/heads/::)

%:
	dh --with quilt $@

override_dh_auto_install:
	dh_auto_install
	install -D -m755 debian/initramfs-hook \
		debian/makedumpfile/usr/share/initramfs-tools/hooks/makedumpfile

guilt-patches:
	dh_testdir
	dh_quilt_unpatch
	test -d .git
	test -n '$(branch)'

	# Make sure no guilt patches are applied.  But don't fail if guilt
	# hasn't been initialized yet.
	guilt status > /dev/null || guilt init
	guilt pop -a

	rm -rf .git/patches/$(branch)
	rsync -av --delete debian/patches/ .git/patches/$(branch)
	touch .git/patches/$(branch)/status

debian/patches:
	dh_testdir
	dh_quilt_unpatch
	test -d .git

	guilt pop -a
	rm -rf debian/patches
	guilt export debian/patches

.PHONY: guilt-patches debian/patches
